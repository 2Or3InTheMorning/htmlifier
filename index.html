<!DOCTYPE html>
<html lang="en">
  <head>
    <title>HTMLifier</title>
    <meta charset="UTF-8">
    <meta name="description" content="Converts a Scratch project to HTML/JavaScript"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!-- no-offline -->
    <link rel="stylesheet" type="text/css" href="../../sheep3.css">
    <script src="../../sheep3.js" charset="utf-8"></script>
    <script src="./offlineifier.js" charset="utf-8"></script>
    <!-- /no-offline -->
    <link href="https://fonts.googleapis.com/css2?family=Exo:wght@500&family=Roboto:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./main.css">
    <script src="./download.js" charset="utf-8"></script>
    <script src="./jszip.min.js" charset="utf-8"></script>
    <style media="screen">
      html {
        /* https://stackoverflow.com/a/56467997 */
        scroll-padding-top: 120px;
      }
      :target {
        animation: flash 3s;
      }
      @keyframes flash {
        0% {
          background-color: rgba(255, 255, 0, 0.5);
        }
        100% {
          background-color: transparent;
        }
      }
      button,
      input[type=file],
      ::-webkit-file-upload-button {
        cursor: pointer;
      }
      input[type=submit] {
        font-size: 1.2em;
      }
      .offline::after {
        content: 'Offline edition';
        position: fixed;
        bottom: 0;
        right: 0;
        color: rgba(0, 0, 0, 0.5);
        margin: 10px;
      }
      fieldset {
        margin: 1em 0;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Project HTMLifier</h1>
      <h3><em>Convert a Scratch project to HTML</em></h3>
      <button class="htmlify" id="other-htmlify-btn">HTMLify</button>
    </div>
    <div class="mainarea">
      <!-- no-offline -->
      <p><button id="offlineify">Download offline version</button> (An HTML file that can be opened and used in the browser without an internet connection)</p>
      <!-- /no-offline -->
      <p>This packages your Scratch project into a single HTML file that can run on its own in a web browser. The HTML file will be pretty big because it contains the entire Scratch engine (2.6 MB) and the costume and sound files used in the project. There is no direct translation between a Scratch block and a JavaScript equivalent because the two languages are fundamentally different, so you should not use the code in the generated file for learning HTML or JavaScript after Scratch.</p>
      <p>The project will automatically start, and there are no green flag or stop sign buttons.</p>
      <p><a href="?" id="options-link">Save options in link</a></p>
      <form id="options"></form>
      <ul class="log" id="log"></ul>
      <p>If you want to view or edit the HTML file, you can use the specialized <a href="https://sheeptester.github.io/words-go-here/htmlifier/large-file-editor/">Large File Editor</a> to hide the long lines that may hang or crash normal text editors.</p>
      <p id="note-1"><a href="#ref-1"><sup>1</sup></a>You may have to deal with privacy laws around cookies outside of Scratch.</p>
      <p id="note-2"><a href="#ref-2"><sup>2</sup></a>Compatibility mode forces projects to run at 30 FPS, like in Scratch 2.0. Turning this off allows the project to run at a higher framerate (usually 60 FPS, depending on the computer screen's refresh rate).</p>
      <p id="note-3"><a href="#ref-3"><sup>3</sup></a>I think the implementation of this is poor. Maybe instead of setting mouse x/y, it can set a cloud variable with a certain name. You can leave feedback and suggestions on <a href="https://scratch.mit.edu/users/Sheep_maker/">my profile</a>.</p>
      <p id="note-4"><a href="#ref-4"><sup>4</sup></a>If a cloud variable with the name "☁ eval" is set, it'll run the variable value as JavaScript and store it in a cloud variable named "☁ eval output"; if there is an error, it'll be stored in "☁ eval error." If you're using a custom cloud server, then cloud variables whose names start with "☁ local storage" will store their values in localStorage instead of in the server.</p>
      <h2>Update history</h2>
      <p>See the code and previous versions on <a href="https://github.com/SheepTester/htmlifier/">Github</a>.</p>
      <h3>2020-06-13</h3>
      <ul>
        <li>More options for styling variable/list monitors</li>
        <li>Option to generate a .zip of files</li>
        <li>Option to preview the HTMLified project</li>
        <li>Readded the option for a progress counter despite lack of demand</li>
        <li>Warn if a file might be too large for JavaScript to HTMLify</li>
        <li>Fixed HTMLifying 2.0 projects</li>
      </ul>
      <h3>2020-06-01</h3>
      <ul>
        <li>Option to remove clone/list length limits</li>
        <li>Option to hide the cursor</li>
        <li>Ability to distinguish between cloud variables for localStorage and the server (and run JavaScript using cloud variables)</li>
        <li>Option for rudimentary pointer lock</li>
        <li>Fixed mouse position and unresized lists not showing</li>
        <li>Default project changed to one of <a href="https://scratch.mit.edu/users/ScratchCat/">ScratchCat</a>'s</li>
        <li>Unfortunately, as part of these changes, I removed the option for a progress bar. If there's demand, I'll try to add it back.</li>
      </ul>
      <h3>2020-05-01</h3>
      <ul>
        <li>Support for custom extensions from a URL</li>
        <li>CSS by <a href="https://scratch.mit.edu/users/mrcringekidyt/">Mr. Cringe Kid</a></li>
      </ul>
      <h3>2020-03-29</h3>
      <ul>
        <li>Fixed custom stage sizes</li>
      </ul>
      <h3>2020-03-27</h3>
      <ul>
        <li>Show an image such as a gif while loading</li>
        <li>Fixed dragging sprites simulating another green flag click</li>
      </ul>
      <h3>2020-01-06</h3>
      <ul>
        <li>An offline version of the HTMLifier</li>
      </ul>
      <h3>2019-12-25</h3>
      <ul>
        <li>An option to use a custom cloud server for cloud variables instead of saving to localStorage</li>
      </ul>
      <h3>2019-11-23</h3>
      <ul>
        <li>A fullscreen button</li>
        <li>An option to change monitor colours</li>
      </ul>
      <h3>2019-10-05</h3>
      <ul>
        <li>New ask box</li>
      </ul>
      <h3>2019-09-28</h3>
      <ul>
        <li>A status text that shows the assets loaded</li>
        <li>Support the video extension</li>
        <li>Support draggable sprites</li>
      </ul>
      <h3>2019-08-08</h3>
      <ul>
        <li>Removed "Scratch" from the name of this utility just in case</li>
      </ul>
      <h3>2019-07-27</h3>
      <ul>
        <li>Support 16:9 projects</li>
        <li>Simplify the number of modes for HTMLification</li>
      </ul>
      <h3>2019-07-13</h3>
      <ul>
        <li>Cloud variables store in localStorage</li>
      </ul>
      <h3>2019-06-29</h3>
      <ul>
        <li>Upload project file instead of using project ID</li>
        <li>Toggle compatibility and turbo mode</li>
      </ul>
      <h3>2019-03-31</h3>
      <ul>
        <li>Variable and list watchers</li>
      </ul>
      <h3>2019-02-09</h3>
      <ul>
        <li>Project start</li>
      </ul>
      <p>Made by <a href="https://scratch.mit.edu/users/Sheep_maker/">Sheep_maker</a>, who used <a href="https://github.com/LLK/scratch-vm/">scratch-vm</a>, <a href="http://danml.com/download.html">download.js</a>, and their dependencies for this project.</p>
      <p>CSS by <a href="https://scratch.mit.edu/users/mrcringekidyt/">Mr. Cringe Kid</a>.</p>
    </div>
    <!-- VM relies on document.body existing oof -->
    <script src="https://sheeptester.github.io/scratch-vm/16-9/vm.min.js" charset="utf-8"></script>
    <script src="./hacky-file-getter.js" charset="utf-8"></script>
    <script type="text/javascript">
const otherHtmlifyBtn = document.getElementById('other-htmlify-btn')
const logOutput = document.getElementById('log')
const optionsLink = document.getElementById('options-link')

let scroll = false
function log (text, style) {
  const entry = document.createElement('div')
  entry.className = `log-entry log-${style}`
  entry.textContent = text
  logOutput.appendChild(entry)
  if (scroll) logOutput.scrollTop = logOutput.scrollHeight
  return entry
}

// {https://link.com/ text to show}
const parseLinksRegex = /{(\S+)\s([^>]+)}/g
function parseLinksAndAddTo (parent, text) {
  if (!text) return
  let match
  let lastIndex = 0
  while ((match = parseLinksRegex.exec(text))) {
    if (lastIndex < match.index) {
      parent.appendChild(
        document.createTextNode(text.slice(lastIndex, match.index))
      )
    }
    const link = document.createElement('a')
    link.href = match[1]
    link.textContent = match[2]
    parent.appendChild(link)
    lastIndex = match.index + match[0].length
  }
  if (lastIndex < text.length - 1) {
    parent.appendChild(
      document.createTextNode(text.slice(lastIndex))
    )
  }
}
const notes = []
function addNote (noteId, note) {
  const ref = document.createElement('a')
  ref.href = `#ref-${noteId}`

  const paragraph = document.createElement('p')
  paragraph.id = `note-${noteId}`
  paragraph.appendChild(ref)
  parseLinksAndAddTo(paragraph, note)
  notes[noteId] = paragraph

  const link = document.createElement('a')
  link.id = `#ref-${noteId}`
  link.href = `#note-${noteId}`
  return link
}
const params = new URL(window.location).searchParams
function paramsUpdate () {
  optionsLink.href = '?' + params.toString()
}
paramsUpdate()
class Option {
  constructor () {
    this.group = null
  }

  addTo (group) {
    this.group = group
    group.element.appendChild(this.element)
  }

  addValuesTo (values) {
    return
  }
}
class Group extends Option {
  constructor () {
    super()

    this.children = []
  }

  add (child, returnChild = false) {
    if (typeof child === 'string') {
      child = new Label(child)
    }
    this.children.push(child)
    child.addTo(this)
    return returnChild ? child : this
  }

  addValuesTo (values) {
    for (const child of this.children) {
      child.addValuesTo(values)
    }
  }
}
class Form extends Group {
  constructor (form = document.createElement('form')) {
    super()

    form.addEventListener('submit', this._handleSubmit.bind(this))
    this._form = form

    this.element = document.createDocumentFragment()
  }

  _handleSubmit (e) {
    e.preventDefault()
    if (this.onSubmit) {
      this.onSubmit(this.values)
    }
  }

  get values () {
    const values = {}
    this.addValuesTo(values)
    return values
  }

  done () {
    const submitBtn = document.createElement('input')
    submitBtn.type = 'submit'
    this.element.appendChild(submitBtn)

    this._form.appendChild(this.element)
    this.element = this._form

    return this
  }
}
class Fieldset extends Group {
  constructor (label) {
    super()

    const labelElem = document.createElement('legend')
    parseLinksAndAddTo(labelElem, label)

    this.element = document.createElement('fieldset')
    this.element.appendChild(labelElem)
  }
}
class Paragraph extends Group {
  constructor (checkableTarget, element, noteId, note) {
    super()

    this.element = element
    this._checkableTarget = checkableTarget
    this.checkable = null

    if (noteId) {
      this.element.appendChild(addNote(noteId, note))
    }
  }

  addCheckable (checkable) {
    const space = document.createTextNode(' ')
    if (this._checkableTarget.firstChild) {
      this._checkableTarget.insertBefore(space, this._checkableTarget.firstChild)
    } else {
      this._checkableTarget.appendChild(space)
    }
    this._checkableTarget.insertBefore(checkable.element, space)

    checkable.input = this
    this.checkable = checkable

    return this
  }

  addValuesTo (values) {
    if (this.checkable) {
      this.checkable.addValuesTo(values)
    }
    super.addValuesTo(values)
  }
}
class Label extends Paragraph {
  constructor (text, noteId, note) {
    const label = document.createElement('label')
    parseLinksAndAddTo(label, text)

    const element = document.createElement('p')
    element.appendChild(label)

    super(label, element, noteId, note)
  }
}
class Input extends Paragraph {
  constructor (name, labelText, { noteId, note, ...properties } = {}) {
    const input = document.createElement('input')
    input.id = name
    input.name = name
    Object.assign(input, properties)
    if (params.get(name)) {
      input.value = params.get(name)
    }

    const [before, after] = labelText.split('%i')
    const label = document.createElement('label')
    parseLinksAndAddTo(label, before)
    label.appendChild(input)
    parseLinksAndAddTo(label, after)

    const element = document.createElement('p')
    element.appendChild(label)

    super(label, element, noteId, note)

    this._name = name
    this._input = input

    input.addEventListener('change', this._handleChange.bind(this))
  }

  get value () {
    if (this._input.type === 'number') {
      return +this._input.value
    } else if (this._input.type === 'file') {
      return this._input.files[0]
    } else {
      return this._input.value
    }
  }

  addValuesTo (values) {
    values[this._name] = this.value
    super.addValuesTo(values)
  }

  _handleChange () {
    params.set(this._name, this._input.value)
    paramsUpdate()
    if (this.checkable) {
      this.checkable.element.checked = true
      this.checkable.handleChange()
    }
  }

  addTo (group) {
    if (group instanceof Paragraph) {
      this.group = group
      // Merge children of paragraphs
      while (this.element.firstChild) {
        group.element.appendChild(this.element.firstChild)
      }
      this.element = group.element
    } else {
      super.addTo(group)
    }
  }
}
class Checkable extends Option {
  constructor (type, name, value, checked = false) {
    super()
    this.name = name
    this.value = value
    this.element = document.createElement('input')
    this.element.type = type
    this.element.name = name
    this.element.id = value && value !== 'on' ? `${name}-${value}` : name
    if (value) this.element.value = value
    if (checked) {
      this.element.checked = true
    }
    this.element.addEventListener('change', this.handleChange.bind(this))
  }

  get checked () {
    return this.element.checked
  }

  handleChange () {
    if (this.element.checked) {
      params.set(this.name, this.value)
    } else {
      params.set(this.name, 'off')
    }
    paramsUpdate()
  }
}
class Checkbox extends Checkable {
  constructor (name, defaultValue) {
    const urlParam = params.get(name)
    super('checkbox', name, 'on', urlParam ? urlParam === 'on' : defaultValue)
  }

  addValuesTo (values) {
    values[this.name] = this.checked
  }
}
class _Radio extends Checkable {
  constructor (group, value, checked) {
    super('radio', group.name, value, checked)
    this.group = group
  }

  handleChange () {
    super.handleChange()
    this.group.handleSelect(this.value)
  }
}
class RadioGroup extends Group {
  constructor (name, defaultValue) {
    super()
    this.element = document.createElement('div')
    this.element.className = 'radio-group'
    this.name = name
    this.value = params.get(name) || defaultValue
  }

  add (input, value = null) {
    input = super.add(input, true)
    input.addCheckable(new _Radio(this, value, this.value === value))
    return this
  }

  handleSelect (value) {
    this.value = value
  }

  addValuesTo (values) {
    values[this.name] = this.value
    super.addValuesTo(values)
  }
}
const form = new Form(document.getElementById('options'))
  .add(
    new RadioGroup('upload-mode', 'id')
      .add(new Input(
        'id',
        'Project ID: %i (the ID of the project on the Scratch website)',
        {
          type: 'number',
          value: 276660763,
          placeholder: 'Project ID'
        }
      ), 'id')
      .add(new Input(
        'file',
        'Upload project file: %i',
        {
          type: 'file',
          accept: '.sb,.sb2,.sb3'
        }
      ), 'file')
  )
  .add(
    new Fieldset('Options')
      .add(new Input(
        'title',
        'Project name: %i (the text displayed in the browser tab)',
        {
          type: 'text',
          value: 'Scratch 3.0 is here!',
          placeholder: 'Project name'
        }
      ))
      .add(new Input(
        'username',
        'Username value: %i (the value that the username block reports)',
        {
          type: 'text',
          value: 'ScratchCat',
          placeholder: 'Username'
        }
      ))
      .add(
        new Label('Show fullscreen button?')
          .addCheckable(new Checkbox('fullscreen', true))
      )
      .add(
        new Label('Enable {https://en.scratch-wiki.info/wiki/Turbo_Mode turbo mode}?')
          .addCheckable(new Checkbox('turbo'))
      )
      .add(
        new Label('Load progress indicator?')
          .addCheckable(new Checkbox('progress', true))
      )
      .add(
        new Input(
          'loading-image-file',
          'Loading image: %i',
          {
            type: 'file',
            accept: 'image/*'
          }
        )
          .addCheckable(new Checkbox('loading-image'))
      )
      .add(
        new Label(
          'Enable compatibility mode?',
          2,
          'Compatibility mode forces projects to run at 30 FPS, like in Scratch 2.0. Turning this off allows the project to run at a higher framerate (usually 60 FPS, depending on the computer screen\'s refresh rate).'
        )
          .addCheckable(new Checkbox('compatibility', true))
      )
      .add(
        new Label('Stretch the canvas to fit (as opposed to maintaining the aspect ratio)?')
          .addCheckable(new Checkbox('stretch'))
      )
      .add(
        new Label('Hide cursor?')
          .addCheckable(new Checkbox('no-cursor'))
      )
      .add(
        new Label(
          'Lock the pointer on click? The mouse x/y blocks will report the mouse movement.',
          3,
          'I think the implementation of this is poor. Maybe instead of setting mouse x/y, it can set a cloud variable with a certain name. You can leave feedback and suggestions on {https://scratch.mit.edu/users/Sheep_maker/ my profile}.'
        )
          .addCheckable(new Checkbox('pointer-lock'))
      )
      .add(
        new Label('Output a .zip file? The .zip file will contain an index.html file and separate files for the project\'s assets.')
          .addCheckable(new Checkbox('zip'))
      )
      .add(
        new Fieldset('Monitor style')
          .add(
            new Input(
              'monitor-colour',
              'Use custom variable/list monitor colour: %i? (If unchecked, a translucent black will be used.)',
              {
                type: 'color',
                value: '#ff8c1a'
              }
            )
              .addCheckable(new Checkbox('use-colour'))
          )
          .add(new Input(
            'monitor-text',
            'Monitor text colour: %i',
            {
              type: 'color',
              value: '#ffffff'
            }
          ))
          .add(
            new Label('Hide the monitor background boxes?')
              .addCheckable(new Checkbox('transparent-monitor'))
          )
      )
      .add(
        new Fieldset('Cloud variable source')
          .add(
            new RadioGroup('cloud-provider', 'localstorage')
              .add(new Label(
                'Save cloud variables locally using localStorage',
                1,
                'You may have to deal with privacy laws around cookies outside of Scratch.'
              ), 'localstorage')
              .add(new Input(
                'cloud-ws',
                'Use a {https://github.com/SheepTester/primitive-cloud-server custom server}: %i',
                {
                  type: 'url',
                  placeholder: 'ws://localhost:3000/'
                }
              ), 'ws')
          )
          .add(
            new Label(
              'Give certain cloud variables special behaviours depending on the name?',
              4,
              'If a cloud variable with the name "☁ eval" is set, it\'ll run the variable value as JavaScript and store it in a cloud variable named "☁ eval output"; if there is an error, it\'ll be stored in "☁ eval error." If you\'re using a custom cloud server, then cloud variables whose names start with "☁ local storage" will store their values in localStorage instead of in the server.'
            )
              .addCheckable(new Checkbox('special-cloud'))
          )
      )
      .add(
        new Fieldset('{https://sheeptester.github.io/scratch-gui/ E羊icques} (modded) options')
          .add(
            new Label('Does this project use a {https://sheeptester.github.io/scratch-gui/?width=640&height=360 custom size}?')
              .addCheckable(new Checkbox('wider'))
              .add(new Input(
                'width',
                'Width: %i',
                {
                  type: 'number',
                  value: '480'
                }
              ))
              .add(new Input(
                'height',
                'Height: %i',
                {
                  type: 'number',
                  value: '360'
                }
              ))
          )
          .add(new Input(
            'extension-url',
            'Load {https://github.com/LLK/scratch-vm/blob/develop/docs/extensions.md#types-of-extensions unofficial extension} from URL: %i',
            {
              type: 'url'
            }
          ))
          .add(
            new Label('Remove limits such as clone and list length limits?')
              .addCheckable(new Checkbox('no-limits'))
          )
      )
  )
  .add(
    new Label('Download automatically?')
      .addCheckable(new Checkbox('autodownload', true))
  )
  .done()

function load () {
  const { values } = form
  console.log(values);
  form.disable()
  otherHtmlifyBtn.disabled = true
  logOutput.innerHTML = ''
  scroll = true
  const project = values['upload-mode'] === 'file'
    ? { file: values.file }
    : { id: values.id + '' }
  downloadAsHTML(project, {
    projectId: values.id + '',

    title: values.title,
    username: values.username,
    fullscreen: values.fullscreen,
    turboMode: values.turbo,
    progressBar: values.progress,
    loadingImage: values['loading-image']
      ? values['loading-image-file']
      : null,
    compatibilityMode: values.compatibility,
    stretch: values.stretch,
    noCursor: values['no-cursor'],
    pointerLock: values['pointer-lock'],
    zip: values.zip,

    monitorColour: values['use-colour']
      ? values['monitor-colour']
      : null,
    monitorText: values['monitor-text'],
    transparentMonitors: values['transparent-monitor'],

    cloudServer: values['cloud-provider'] === 'ws'
      ? values['cloud-ws']
      : null,
    specialCloud: values['special-cloud'],

    customRatio: values.wider,
    width: values.wider ? values.width : 480,
    height: values.wider ? values.height : 360,
    extension: values['extension-url'] || null,
    noLimits: values['no-limits'],

    log
  })
    .then(blob => {
      function downloadBlob () {
        log('Attempting to download file.', 'status');
        download(blob, title.value + (blob.type === 'application/zip' ? '.zip' : '.html'), blob.type);
      }
      if (autodownload.checked) {
        downloadBlob();
      }
      const entry = log('Done! ', 'done');
      const downloadBtn = document.createElement('button');
      downloadBtn.textContent = 'Download';
      downloadBtn.addEventListener('click', downloadBlob);
      entry.appendChild(downloadBtn);
      if (blob.type === 'text/html') {
        const previewBtn = document.createElement('button');
        previewBtn.textContent = 'Open preview';
        previewBtn.addEventListener('click', async e => {
          const newTab = window.open('', '_blank');
          newTab.document.write('<style>html, body { height: 100%; margin: 0; }</style><body></body>');
          const frame = document.createElement('iframe');
          frame.style = 'width: 100%; height: 100%; border: none;';
          frame.srcdoc = await blob.text();
          frame.addEventListener('load', e => {
            newTab.document.title = frame.contentDocument.title;
          });
          newTab.document.body.appendChild(frame);
        })
        entry.appendChild(previewBtn);
      }
      loadNoMinifyBtn.disabled = false;
      otherHtmlifyBtn.disabled = false;
    }).catch(err => {
      console.error(err);
      if (err.message !== 'error logged') {
        log('Unexpected error:\n' + err.stack, 'error');
      }
      loadNoMinifyBtn.disabled = false;
      otherHtmlifyBtn.disabled = false;
      scroll = false;
    });
}
form.onSubmit = load
otherHtmlifyBtn.addEventListener('click', load)
/*

let defaultTitle = true;
title.addEventListener('change', e => {
  defaultTitle = false;
});

if (defaultTitle) {
  title.value = file.files[0].name.replace(/\.\w+$/, '').replace(/_/g, ' ')
}
*/
/* no-offline */
const offlineifyBtn = document.getElementById('offlineify');
offlineifyBtn.addEventListener('click', e => {
  logOutput.innerHTML = '';
  offlineifyBtn.disabled = true;
  scroll = true;
  offlineify({log})
    .then(() => {
      offlineifyBtn.disabled = false;
    })
    .catch(err => {
      console.error(err);
      if (err.message !== 'error logged') {
        log('Unexpected error:\n' + err.stack, 'error');
      }
      offlineifyBtn.disabled = false;
      scroll = false;
    });
})
/* /no-offline */
    </script>
  </body>
</html>
